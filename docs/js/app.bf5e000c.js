(function(){var e={7468:function(e,t,s){"use strict";var i=s(2856),a=function(){var e=this,t=e._self._c;return t("div",{staticClass:"no-select",attrs:{id:"app"},on:{dragover:function(e){e.preventDefault()},drop:function(t){return t.preventDefault(),e.handleDrop.apply(null,arguments)}}},[t("canvas",{ref:"paperCanvas",class:{debug:e.$root.debug},staticStyle:{"z-index":"0"},attrs:{id:"paper-canvas",width:"100%",height:"100%"}}),t("img",{staticClass:"app-button scale-hover",staticStyle:{right:"20px"},attrs:{id:"add-button",src:"icons/add.svg"},on:{click:function(t){e.adding=!e.adding}}}),t("div",{directives:[{name:"show",rawName:"v-show",value:e.adding,expression:"adding"}],staticStyle:{position:"absolute",bottom:"70px",right:"20px"}},[e._l(Object.keys(e.presets),(function(s){return t("div",{key:s,staticClass:"add-sample-button scale-hover no-drag",on:{click:function(t){return e.addPreset(s)}}},[e._v(" "+e._s(s)+" ")])})),t("div",{staticClass:"add-sample-button scale-hover",on:{click:e.addSample}},[e._v("📁")])],2),t("img",{staticClass:"app-button scale-hover",staticStyle:{right:"80px"},attrs:{id:"add-button",src:"icons/trash.svg"},on:{click:e.removeSample}}),t("img",{staticClass:"app-button",staticStyle:{right:"140px"},attrs:{id:"save-button",src:"icons/save.svg"},on:{click:e.saveSession}}),t("img",{staticClass:"app-button",class:{recording:e.recording},staticStyle:{right:"200px"},attrs:{id:"record-button",src:"icons/record.svg"},on:{click:e.toggleSimpleRecord}}),t("img",{staticClass:"app-button",class:{recording:e.microphoning},staticStyle:{right:"260px"},attrs:{id:"mic-button",src:"icons/mic.svg"},on:{click:e.toggleMicrophone}}),e._l(e.samples,(function(s){return t("Sample",{key:s.idx,ref:"samples",refInFor:!0,attrs:{name:s.name,audio:s.audio,position:s.position,idx:s.idx,"audio-buffer":s.buffer},nativeOn:{mouseover:function(t){e.$root.lastSampleInteractionIdx=s.idx}}})})),t("Reverb",{ref:"reverb",staticStyle:{bottom:"50px",left:"30px"}}),t("Delay",{ref:"delay",staticStyle:{bottom:"50px",left:"280px"}}),t("input",{ref:"fileChooser",staticStyle:{display:"none"},attrs:{id:"hiddenFileInput",type:"file",accept:".mp3"},on:{change:e.handleSampleFileUpload}}),t("a",{attrs:{href:"https://github.com/Digitopia/DigiCanvas",target:"_blank"}},[t("img",{staticClass:"app-button scale-hover",attrs:{id:"info-button",src:"icons/info.svg"},on:{click:function(t){e.showInfo=!0}}})])],2)},n=[],r=(s(4114),s(6573),s(8100),s(7936),s(7467),s(4732),s(9577),s(4603),s(7566),s(8721),s(5239)),o=s.n(r),l=function(){var e=this,t=e._self._c;return t("Effect",{attrs:{params:e.params,"effect-node":e.delayNode,icon:"icons/delay.svg",name:"delay"}})},d=[],c=s(2557),h=function(){var e=this,t=e._self._c;return t("div",{ref:"effect",staticClass:"effect"},[t("div",{ref:"effectArea",staticClass:"effect-area"}),t("div",{ref:"effectCenter",staticClass:"effect-center",style:{backgroundImage:`url('${e.icon}')`},on:{dblclick:function(t){t.stopPropagation(),e.showSliders=!e.showSliders},touchstart:function(t){return t.stopPropagation(),e.touchStart.apply(null,arguments)}}}),t("div",{directives:[{name:"show",rawName:"v-show",value:e.showSliders,expression:"showSliders"}],staticClass:"sliders"},e._l(e.params,(function(s,i,a){return t("round-slider",{key:i,staticStyle:{position:"absolute"},attrs:{id:i,"start-angle":e.getStartAngle(s,a),"end-angle":e.getEndAngle(s),"line-cap":"round",width:"8","path-color":"rgba(255,255,255,0.4)","range-color":"var(--blue)",animation:!1,radius:"50","show-tooltip":!1,"keyboard-action":!1,min:s.min,max:s.max,step:s.step,"handle-size":"+8",update:e.handleParamChange},model:{value:s.value,callback:function(t){e.$set(s,"value",t)},expression:"param.value"}})})),1)])},u=[],g=s(5537),p=s(6517),m=s(5193);const f=(e,t,s,i,a)=>(e-t)*(a-i)/(s-t)+i;function v(e,t,s){return Math.min(s,Math.max(t,e))}function b(e,t){return Math.random()*(t-e)+e}function w(e,t){return Math.round(b(e,t))}function y(e=0,t=1){const s=1-Math.random(),i=Math.random(),a=Math.sqrt(-2*Math.log(s))*Math.cos(2*Math.PI*i);return a*t+e}function x(e,t,s){let i,a,n,r,o,l,d,c,h,u,g,p;return i=e[0],a=e[1],n=e[2],r=e[3],o=t[0],l=t[1],d=t[2],c=t[3],h=i+(o-i)*s,u=a+(l-a)*s,g=n+(d-n)*s,p=r+(c-r)*s,[h,u,g,p]}function S(e,t,s){const i=f(e,t,s,0,1),a=i**2,n=+f(a,0,1,t,s).toFixed(2);return n}function $(e,t,s){const i=f(e,t,s,0,1),a=Math.max(Math.log10(i+.1)+.96,0),n=+f(a,0,1,t,s).toFixed(2);return n}function C(e,t){t=t||{};var s,i=e.numberOfChannels,a=e.sampleRate,n=t.float32?3:1,r=3===n?32:16;return s=2===i?R(e.getChannelData(0),e.getChannelData(1)):e.getChannelData(0),A(s,n,a,i,r)}function A(e,t,s,i,a){var n=a/8,r=i*n,o=new ArrayBuffer(44+e.length*n),l=new DataView(o);return D(l,0,"RIFF"),l.setUint32(4,36+e.length*n,!0),D(l,8,"WAVE"),D(l,12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,t,!0),l.setUint16(22,i,!0),l.setUint32(24,s,!0),l.setUint32(28,s*r,!0),l.setUint16(32,r,!0),l.setUint16(34,a,!0),D(l,36,"data"),l.setUint32(40,e.length*n,!0),1===t?N(l,44,e):k(l,44,e),o}function R(e,t){var s=e.length+t.length,i=new Float32Array(s),a=0,n=0;while(a<s)i[a++]=e[n],i[a++]=t[n],n++;return i}function k(e,t,s){for(var i=0;i<s.length;i++,t+=4)e.setFloat32(t,s[i],!0)}function N(e,t,s){for(var i=0;i<s.length;i++,t+=2){var a=Math.max(-1,Math.min(1,s[i]));e.setInt16(t,a<0?32768*a:32767*a,!0)}}function D(e,t,s){for(var i=0;i<s.length;i++)e.setUint8(t+i,s.charCodeAt(i))}function P(e){const t=e.getBoundingClientRect(),s=t.left+t.width/2,i=t.top+t.height/2;return{x:s,y:i}}function E(e,t=2){return+e.toFixed(t)}var O=function(){var e=this,t=e._self._c;return t("div",{ref:"sample",staticClass:"container",class:{debug:e.$root.debug},staticStyle:{margin:"0"}},[t("div",{staticClass:"sample",class:{playing:e.isPlaying}},[t("div",{directives:[{name:"show",rawName:"v-show",value:"settings"===e.controls,expression:"controls === 'settings'"}],staticClass:"controls no-select",on:{click:function(t){return t.stopPropagation(),e.toggleControls(e.controls)}}},[t("div",{directives:[{name:"show",rawName:"v-show",value:"sample"==e.mode,expression:"mode == 'sample'"}],staticClass:"spaced-out"},e._l(e.settings.sample.modes,(function(s){return t("img",{key:s,staticClass:"sample-mode-icon",class:{active:e.settings.sample.mode===s,disabled:"back-and-forth"===s},attrs:{src:`icons/${s}.svg`},on:{click:function(t){t.stopPropagation(),e.settings.sample.mode=s}}})})),0),t("div",{directives:[{name:"show",rawName:"v-show",value:"granular"===e.mode,expression:"mode === 'granular'"}],staticClass:"granular-sliders spaced-out"},[t("div",{attrs:{id:`filtering-${e.idx}`},on:{click:function(e){e.stopPropagation()}}},[e._v("Fs")]),t("div",{attrs:{id:`grainSize-${e.idx}`},on:{click:function(e){e.stopPropagation()}}},[e._v("Gs")]),t("div",{attrs:{id:`rate-${e.idx}`},on:{click:function(e){e.stopPropagation()}}},[e._v("Rt")]),t("div",{attrs:{id:`random-${e.idx}`},on:{click:function(e){e.stopPropagation()}}},[e._v("Rd")])])]),t("div",{ref:"header",staticClass:"header scale-hover",on:{dblclick:e.toggleEditName}},[e.isEditingName?[t("input",{directives:[{name:"model",rawName:"v-model",value:e.editName,expression:"editName"}],staticStyle:{"text-align":"center"},attrs:{type:"text",maxlength:"20"},domProps:{value:e.editName},on:{keypress:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.toggleEditName.apply(null,arguments)},input:function(t){t.target.composing||(e.editName=t.target.value)}}})]:[e._v(" "+e._s(e.name)+" ")]],2),t("div",{ref:"waveformWrapper",attrs:{id:"waveform-wrapper"}},[t("div",{ref:"waveform",class:`waveform-${e.idx}`}),t("canvas",{ref:"canvas",staticClass:"canvas"})]),t("div",{attrs:{id:"buttons"}},[t("div",{class:{active:"settings"===e.controls},attrs:{id:"settings-btn"},on:{click:function(t){return t.stopPropagation(),e.toggleControls("settings")}}},[t("img",{staticClass:"control-icon",attrs:{src:"icons/overlay.svg",alt:""}})]),t("div",{attrs:{id:"mode-btn"},on:{click:function(t){return t.stopPropagation(),e.toggleMode()}}},[t("img",{staticClass:"control-icon",attrs:{src:"sample"===e.mode?"icons/play.svg":"icons/granular.svg",alt:""}})]),t("div",{ref:"scaleButton",staticStyle:{"background-image":"url('icons/stretch.svg')"},attrs:{id:"scale-btn"},on:{click:function(t){return t.stopPropagation(),e.toggleControls("scale")}}},[t("img",{ref:"scaleImage",staticClass:"control-icon",attrs:{id:"scale-img",src:"icons/stretch.svg",alt:""},on:{dblclick:e.resetTimestretch}})])])])])},z=[],I=s(8664),T=s(3780),U=s(2493),_=s.n(U);const M=40,W=600,G=120,L=128;var B={props:{audio:{type:String,required:!0},audioBuffer:{type:AudioBuffer,required:!1},name:{type:String,required:!0},idx:{type:Number,required:!0},position:{type:Object,required:!1}},data(){return{audioNode:null,audioGainNode:null,effectSends:{reverb:null,delay:null},audioElementSource:null,isEditingName:!1,editName:null,wavesurfer:null,controls:"",mode:"sample",settings:{sample:{modes:["one-shot","loop"],mode:"loop"},granular:{origin:.5,params:{grainSize:{min:.1,max:1.5,step:.01,value:.2},rate:{min:.1,max:1.5,value:1.5},random:{min:0,max:1,value:.8}},sliders:{},grains:[],envelope:{attack:.02,release:.02}},scale:{params:{amplitude:{min:.05,max:1.5,value:1},timestretch:{value:1}}},filtering:{active:null,slider:{min:0,max:1,value:.2,step:.01},highpass:{min:0,max:5e3,value:2e3,audioNode:null},lowpass:{min:200,max:2e4,value:1,audioNode:null}}},region:null,isPlaying:!1,canvas:null,canvasCtx:null,width:null,height:null,pixelsPerSecond:M,maxWidth:W,minWidth:G,originalDuration:null,originalWidth:null,paperRect:null}},computed:{maxDuration(){return this.maxWidth/this.pixelsPerSecond},isLooping(){return!("sample"===this.mode&&"one-shot"===this.settings.sample.mode)},bufferDuration(){return this.audioNode&&this.audioNode.buffer?this.audioNode.buffer.duration:NaN},grainSize(){return this.settings.granular.params.grainSize.value}},watch:{isPlaying(){console.debug("isPlaying",this.isPlaying)},controls(){console.debug("controls are now",this.controls);const e=null===this.controls||"scale"===this.controls;this.settings.region.setOptions({resize:e,drag:e})}},created(){window.sample=this,window.getCenter=P},mounted(){this.editName=this.name,this.initWaveform(),this.initAudio(),this.initGranularSliders(),this.initCanvas(),this.$refs.sample.style.minWidth=this.minWidth+"px",this.$refs.sample.style.maxWidth=this.maxWidth+"px",this.$root.$on("toggleControls",this.toggleControls),this.$root.$on("effectDragUseArea",this.effectDragUseArea),document.addEventListener("keydown",(e=>{"Backspace"!==e.key||this.$root.lastSampleInteractionIdx!==this.idx||this.isEditingName||this.$destroy()})),window.grains=this.settings.granular.grains,window.mapLog=$},beforeDestroy(){console.info("beforeDestroy",this.name,this.idx),this.resizeObserver.unobserve(this.$refs.sample),this.$root.$off("toggleControls",this.toggleControls),this.$root.$off("effectDragUseArea",this.effectDragUseArea),this.$el.parentNode.removeChild(this.$el);const e=[this.audioNode,this.audioGainNode,this.effectSends.reverb,this.effectSends.delay,this.settings.filtering.lowpass.audioNode,this.settings.filtering.highpass.audioNode];e.forEach((e=>{e&&(e.dispose(),e=null)}))},methods:{getInvertedRate(){return f(this.settings.granular.params.rate.value,this.settings.granular.params.rate.min,this.settings.granular.params.rate.max,this.settings.granular.params.rate.max,this.settings.granular.params.rate.min)},toggleEditName(){this.isEditingName=!this.isEditingName,this.isEditingName?this.draggable.disable():(this.name=this.editName,this.draggable.enable())},timestamp2Progress(e){return f(e,0,this.bufferDuration,0,1)},async initWaveform(){const e=I.A.create({container:this.$refs.waveform,backgroundColor:"rgba(255, 255, 255, 0.1)",waveColor:"lightgray",progressColor:"lightgray",cursorColor:"black",cursorWidth:1,barWidth:2,barHeight:1,barGap:3,normalize:!1,interact:!1,hideScrollbar:!0,plugins:[T.A.create({})]});if(this.regionsPlugin=e.registerPlugin(T.A.create()),e.on("ready",(async()=>{console.debug("waveform ready for",this.audio),this.audioElementSource=c.SD().createMediaElementSource(e.media),c.Ng(this.audioElementSource,this.audioGainNode),await this.resize(),this.initDraggable(),this.initPosition()})),e.on("finish",(()=>{this.isLooping&&this.settings.region.play()})),this.wavesurfer=e,this.$refs.waveform.addEventListener("click",this.onClick),this.audioBuffer){const t=e.loadBlob(this.audio,[this.audioBuffer.getChannelData(0)],this.audioBuffer.duration);console.debug(t)}else e.load(this.audio)},initPosition(){let e,t;this.position?(console.log("using provided position",this.position),e=this.position.x,t=this.position.y):0===this.idx?(e=window.innerWidth/2-this.width/2,t=window.innerHeight/2-this.height/2-75):(e=w(0,window.innerWidth-1.2*this.width),t=w(0,window.innerHeight-1.2*this.height)),m.Ay.to(this.$refs.sample,{x:e,y:t,ease:"power2.out",duration:.4,opacity:1,onComplete:()=>{const{x:e,y:t}=P(this.$refs.waveform);this.paperRect=new this.$root.paper.Path.Rectangle({position:{x:e,y:t},size:[this.width,this.height],fillColor:"lightblue",strokeColor:"blue"})}})},initDraggable(){this.draggable=p.A.create(this.$refs.sample,{trigger:this.$refs.header,type:"x,y",bounds:"html",zIndexBoost:!0,onDrag:()=>{this.$root.$emit("effectDragUseArea",this.$parent.$refs.reverb.$children[0]),this.$root.$emit("effectDragUseArea",this.$parent.$refs.delay.$children[0]);const{x:e,y:t}=P(this.$refs.waveform);this.paperRect.set({position:{x:e,y:t}})}})[0],m.Ay.set(this.$refs.sample,{x:window.innerWidth/2-this.width/2,y:window.innerHeight/2-this.height/2})},initAudio(){console.debug("init audio"),this.audioNode=new c.ai(this.audio,(()=>{console.debug("loaded audio",this.audio),this.originalDuration=this.bufferDuration,this.$refs.sample.style.width=this.bufferDuration*this.pixelsPerSecond+"px",this.originalWidth=parseInt(this.$refs.sample.style.width),this.resetTimestretch(),this.initResizeObserver(),this.initScaleDraggable(),setTimeout((()=>{this.initRegion(),this.stop()}),200)})),this.audioNode.onerror=e=>{console.error("Error loading audio",e)},this.audioNode.volume.value=-6,this.audioGainNode=new c.OZ(this.settings.scale.params.amplitude.value);const e=["reverb","delay"];e.forEach((e=>{this.effectSends[e]=new c.OZ(0),this.effectSends[e].connect(this.$root.effectNodes[e]),this.audioGainNode.connect(this.effectSends[e])}));const t=["highpass","lowpass"];t.forEach((e=>{const t=this.settings.filtering[e],s=new c.dJ(t.value,e);s.connect(this.$root.preMaster),t.audioNode=s}))},initGranularSliders(){const e={size:[20,80],mode:"relative"},t=new(_().Slider)(`#grainSize-${this.idx}`,{...e,...this.settings.granular.params.grainSize});this.settings.granular.sliders.grainSize=t;const s=this;t.on("change",(function(e){const t=S(e,s.settings.granular.params.grainSize.min,s.settings.granular.params.grainSize.max);console.debug("[grain-size]",`val=${E(e).toString().padStart(2)}`,`exp=${E(t).toString().padStart(2)}`),s.settings.granular.params.grainSize.value=t}));const i=new(_().Slider)(`#rate-${this.idx}`,{...e,...this.settings.granular.params.rate});this.settings.granular.sliders.rate=i,i.on("change",(e=>{const t=$(e,this.settings.granular.params.rate.min,this.settings.granular.params.rate.max);this.settings.granular.params.rate.value=t,console.debug("[rate]",`val=${E(e)}`,`log=${E(t)}`,`inv=${E(this.getInvertedRate())}`)}));const a=new(_().Slider)(`#random-${this.idx}`,{...e,...this.settings.granular.params.random});this.settings.granular.sliders.rate=a,a.on("change",(e=>{console.debug("[random]",`val=${E(e)}`),this.settings.granular.params.random.value=e}));const n=new(_().Slider)(`#filtering-${this.idx}`,{...e,...this.settings.filtering.slider});n.on("change",(e=>{let t,s;e>=.5?(s="highpass",t=f(e,.5,1,this.settings.filtering.highpass.min,this.settings.filtering.highpass.max),this.settings.filtering.highpass.value=t,this.settings.filtering.highpass.audioNode.frequency.rampTo(t,.1)):(s="lowpass",t=f(e,0,.5,this.settings.filtering.lowpass.min,this.settings.filtering.lowpass.max),this.settings.filtering.lowpass.value=t,this.settings.filtering.lowpass.audioNode.frequency.rampTo(t,.1)),console.debug("[filtering]",`val=${E(e)}`,`type=${s}`,`freq=${E(t)}`),this.settings.filtering.active!==s&&(this.audioGainNode.disconnect(),this.audioGainNode.connect(this.settings.filtering[s].audioNode),this.settings.filtering.active=s),this.settings.filtering.value=e})),n.value=n.value;const r=[t,i,a,n];r.forEach((e=>{e.colorize("accent","var(--blue)"),e.colorize("fill","var(--blue-light)")}))},updateAmplitude(e){console.debug("amplitude is now",e),this.wavesurfer.setOptions({barHeight:e}),console.debug("using amplitude of ",e,"to apply in gain node"),this.audioGainNode.gain.exponentialRampToValueAtTime(e,.02),this.settings.scale.params.amplitude.value=e},updateTimestretch(e){console.debug("timestretch is now",e),this.$refs.sample.style.width=`${e}px`;const t=1/(e/this.originalWidth),s=[255,255,255,.95],i=[255,255,255,.95],a=x(s,i,f(e,this.minWidth,this.maxWidth,0,1));this.$refs.sample.style.backgroundColor=`rgba(${a[0]},${a[1]},${a[2]},${a[3]})`,this.settings.scale.params.timestretch.value=t,console.debug("playbackRate",t),this.resize(),this.wavesurfer.setPlaybackRate(t,!1)},initCanvas(){this.canvas=this.$refs.canvas,this.canvasCtx=this.canvas.getContext("2d"),this.resize()},initScaleDraggable(){const e=this;p.A.create(this.$refs.scaleImage,{trigger:this.$refs.scaleImage,type:"y",lockAxis:!0,bounds:{minY:0,maxY:-128},onDragEnd:function(){m.Ay.to(this.target,{y:0,ease:"power2.out",duration:.2})},onDragStart:()=>{m.Ay.set(this.$refs.scaleImage,{cursor:"grabbing"})},onDrag:function(){if(console.debug("end",this.endX,this.endY),"x"===this.lockedAxis){const t=f(this.endY,0,-128,e.settings.scale.params.amplitude.min,e.settings.scale.params.amplitude.max);e.updateAmplitude(t)}}})},initResizeObserver(){const e=new ResizeObserver((e=>{e.forEach((e=>{const t=e.contentRect.width;console.debug("newWidth",t),this.updateTimestretch(t)}))}));e.observe(this.$refs.sample),this.resizeObserver=e},resetTimestretch(){this.updateTimestretch(this.originalDuration*this.pixelsPerSecond),this.updateAmplitude(1)},initRegion(){console.debug("initting region...");const e=0,t=this.audioNode.buffer.duration;this.settings.region=this.regionsPlugin.addRegion({start:e,end:t,content:"",color:"rgba(170, 197, 216, 0.1)",resize:!0,drag:!0,loop:!1}),console.debug("added region",this.settings.region),this.settings.region.on("update",(()=>{"granular"===this.mode&&this.updateGranularOrigin()})),this.regionsPlugin.on("region-update-end",(()=>{"sample"!==this.mode||this.isPlaying||this.stop()})),this.regionsPlugin.on("region-out",(e=>{console.debug("region out"),this.isLooping?(console.debug("playing region again"),e.play()):this.stop()}))},updateGranularOrigin(){const{start:e,end:t}=this.settings.region,s=(t-e)/2+e;this.settings.granular.origin=this.timestamp2Progress(s)},async resize(){return console.debug("resizing..."),new Promise((e=>{setTimeout((()=>{this.width=this.$refs.waveformWrapper.clientWidth,console.debug("init in resize width is",this.width),this.height=this.$refs.waveformWrapper.clientHeight,console.debug({height:this.height}),console.debug(this.width,this.height),this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height),this.wavesurfer.setOptions({height:this.height}),e()}),100)}))},play(){"sample"===this.mode?(this.wavesurfer.setOptions({cursorColor:"black"}),this.settings.region.play(),this.audioGainNode.gain.exponentialRampToValueAtTime(1,.02)):(this.resize(),this.addGrain(),this.updateRateInterval()),this.isPlaying=!0},stop(){"sample"===this.mode?(this.wavesurfer.setOptions({cursorColor:"transparent"}),this.wavesurfer.stop(),this.wavesurfer.seekTo(this.timestamp2Progress(this.settings.region.start))):(this.clearGranularInterval(),this.clearCanvas()),this.isPlaying=!1},toggleControls(e){console.debug("toggling controls:",e),this.controls=this.controls===e?null:e},toggleMode(){const e=this.isPlaying;this.updateGranularOrigin(),this.stop(),this.clearGrains(),this.mode="sample"===this.mode?"granular":"sample",console.debug("mode is now",this.mode),"sample"==this.mode?this.wavesurfer.setOptions({interact:!0}):"granular"==this.mode&&this.wavesurfer.setOptions({interact:!1}),e&&this.play()},clearGranularInterval(){console.debug("clearing granular interval",this.settings.granular.params.rate.interval),clearInterval(this.settings.granular.params.rate.interval)},updateRateInterval(){this.clearGranularInterval();const e=Math.round(1e3*this.getInvertedRate());console.debug("INVERTED RATE",e),this.settings.granular.params.rate.interval=setInterval((e=>{this.addGrain();const t=Math.round(1e3*this.getInvertedRate());e!==t&&this.updateRateInterval()}),e,e)},addGrain(){this.buffer=this.audioNode.buffer.getChannelData(0);const e=f(this.settings.granular.origin,0,1,0,this.bufferDuration),t=(this.settings.region.end-this.settings.region.start)/4,s=f(this.settings.granular.params.random.value,0,1,0,t),i=y(0,s),a=v(e+i,this.settings.region.start,this.settings.region.end),n=new c.ai(this.audioNode.buffer);n.fadeIn=this.settings.granular.envelope.attack,n.fadeOut=this.settings.granular.envelope.release,n.playbackRate=this.settings.scale.params.timestretch.value,setTimeout((()=>{this.settings.granular.grains.shift(),this.drawGrains()}),1e3*this.grainSize),n.volume.value=-6,n.connect(this.audioGainNode),n.start("+0",a,this.grainSize);const r=f(a,0,this.bufferDuration,0,this.width);this.settings.granular.grains.push({x:r}),this.drawGrains()},clearCanvas(){this.canvasCtx.clearRect(0,0,this.width,this.height)},clearGrains(){this.settings.granular.grains=[],this.drawGrains()},drawGrains(){this.clearCanvas(),this.canvasCtx.fillStyle="rgba(10, 10, 10, 0.4)",this.canvasCtx.beginPath();for(let e=0;e<this.settings.granular.grains.length;e++){const{x:t}=this.settings.granular.grains[e];this.canvasCtx.fillStyle="var(--blue)",this.canvasCtx.beginPath();const s=this.width/this.bufferDuration*this.grainSize/2;console.debug("HEIGHT",this.height),this.canvasCtx.arc(t,this.height/2,s,0,2*Math.PI),this.canvasCtx.fill(),this.canvasCtx.closePath()}},onClick(){c._O.resume(),this.controls||(console.debug("click"),"sample"===this.mode?this.wavesurfer.isPlaying()?(console.debug("stopping..."),this.stop()):this.play():"granular"===this.mode&&(0===this.settings.granular.grains.length?this.play():this.stop()))},effectDragUseDistance(e){const t=e.name,s=e.$el.querySelector(".effect-area"),{x:i,y:a}=P(s),{x:n,y:r}=P(this.$refs.waveform),o=i-n,l=a-r,d=Math.round(Math.sqrt(o*o+l*l)),c=s.getBoundingClientRect(),h=c.width;if(d>h)return;const u=f(d,0,h,1,0).toFixed(2);console.debug(`d(${this.name}, ${t}) = ${d}px effectSend(${u})`),this.effectSends[t].gain.exponentialRampToValueAtTime(u,.02)},effectDragUseArea(e){const t=e.name,s=this.paperRect,i=e.$data.paperCircle,a=i.toPath(),n=s.intersect(a);if(a.remove(),!n)return;const r=n.area/s.area;n.remove(),console.debug(`U(${t},${this.name})=`,`${(100*r).toFixed(2)}%`);const o=r;o&&this.setEffectSend(t,o)},setEffectSend(e,t){this.effectSends[e].gain.value=t},getSaveData(){return{...P(this.$el),name:this.name,mode:this.mode,settings:{sample:{mode:this.settings.sample.mode},granular:{origin:this.settings.granular.origin,params:{grainSize:{value:this.settings.granular.params.grainSize.value},rate:{value:this.settings.granular.params.rate.value},random:{value:this.settings.granular.params.random.value}}},scale:{params:{amplitude:{value:this.settings.scale.params.amplitude.value},timestretch:{value:this.settings.scale.params.timestretch.value}}}}}}}},F=B,j=s(1656),q=(0,j.A)(F,O,z,!1,null,"0bac1601",null),H=q.exports;m.Ay.registerPlugin(p.A);var V={components:{RoundSlider:g.A},props:{params:{type:Object,required:!0},name:{type:String,required:!0},icon:{type:String,required:!0}},data(){return{effectNode:null,showSliders:!1,sliderArcAngle:90,rangeRadius:null,paperCircle:null,touched:!1}},computed:{sliderArcAngleStep(){const e=Object.keys(this.params).length,t=360-e*this.sliderArcAngle;return t/e},sliderArcAngleAngleOffset(){return this.sliderArcAngle+this.sliderArcAngleStep/2-90}},created(){const e=1.05*Math.sqrt(W**2+L**2);console.debug("maxRangeWith",e),this.params.range={min:200,max:e,step:1,value:200,handler:e=>{console.debug("handler in EFFECT of range is now",e);const{min:t,max:s}=this.params.range,i=f(e,t,s,1,s/t);console.debug(`range is now ${e}px scale(${i})`),this.$refs.effectArea.style.transform=`scale(${i}) `;const a=this.$refs.effectArea.clientWidth/2*i;console.debug("newRadius",a),this.paperCircle.set({radius:a}),this.updatePaperCircle()}},this.rangeRadius=this.params.range.value},mounted(){this.initDraggable(),setTimeout((()=>{const{x:e,y:t}=P(this.$refs.effectArea),s=this.$refs.effectArea.clientWidth/2;this.paperCircle=new this.$root.paper.Shape.Circle({center:[e,t],radius:s,fillColor:"red",strokeColor:"black",strokeWidth:2})}),1e3)},methods:{touchStart(){this.touched&&(this.showSliders=!this.showSliders),setTimeout((()=>{this.touched=!1}),300),this.touched=!0},initDraggable(){p.A.create(this.$refs.effect,{trigger:this.$refs.effectCenter,type:"x,y",bounds:"html",zIndexBoost:!1,onDragStart:()=>{const e=document.querySelectorAll(".effect-area"),t=Math.max(...Array.from(e).map((e=>parseInt(e.style.zIndex))));this.$refs.effectArea.style.zIndex=t+1},onDrag:()=>{this.$root.$emit("effectDragUseArea",this),this.updatePaperCircle()}})},getStartAngle(e,t){return e.startAngle?e.startAngle:t*this.sliderArcAngle+t*this.sliderArcAngleStep-this.sliderArcAngleAngleOffset},getEndAngle(e){return e.endAngle?e.endAngle:`+${this.sliderArcAngle}`},updatePaperCircle(){const{x:e,y:t}=P(this.$refs.effectArea);this.paperCircle.set({position:{x:e,y:t}})},handleParamChange(e){const t=e.id,s=e.value;this.params[t].handler(s),this.updatePaperCircle()}}},Y=V,Z=(0,j.A)(Y,h,u,!1,null,null,null),J=Z.exports,X={components:{Effect:J},data(){return{delayNode:null,params:{delayTime:{min:.01,max:2.5,step:.01,value:.5,handler:e=>{const{min:t,max:s}=this.params.delayTime,i=S(e,t,s);console.debug("delay time is now",e,i)}},feedback:{min:0,max:1,step:.01,value:.5,handler:e=>{console.debug("feedback is now",e),this.delayNode.feedback.rampTo(e,.01)}}}}},mounted(){this.delayNode=new c.F(this.params.delayTime.value,this.params.feedback.value).toDestination(),console.debug("created delay node"),this.$root.effectNodes||(this.$root.effectNodes=[]),this.$root.effectNodes["delay"]=this.delayNode},methods:{getSaveData(){return{...P(this.$el),name:this.name,params:{delayTime:{value:this.params.delayTime.value},feedback:{value:this.params.feedback.value},range:{value:this.params.range.value}}}}}},K=X,Q=(0,j.A)(K,l,d,!1,null,null,null),ee=Q.exports,te=function(){var e=this,t=e._self._c;return t("Effect",{attrs:{params:e.params,"effect-node":e.reverbNode,icon:"icons/reverb.svg",name:"reverb"}})},se=[],ie={components:{Effect:J},data(){return{reverbNode:null,params:{decay:{min:.15,max:1.5,step:.01,value:.5,handler:e=>{console.debug("decay/roomsize is now",e),this.reverbNode.decay=e},startAngle:-15,endAngle:195}}}},mounted(){this.params.range.startAngle=225,this.params.range.endAngle="+90",this.reverbNode=new c.zb(this.params.decay.value);const e=-30,t=3;this.compressorNode=new c.wf(e,t),this.reverbNode.chain(this.compressorNode,this.$root.preMaster),this.$root.effectNodes||(this.$root.effectNodes=[]),this.$root.effectNodes["reverb"]=this.reverbNode},methods:{getSaveData(){return{...P(this.$el),name:this.name,params:{dampening:{value:this.params.dampening.value},decay:{value:this.params.decay.value},range:{value:this.params.range.value}}}}}},ae=ie,ne=(0,j.A)(ae,te,se,!1,null,null,null),re=ne.exports,oe=s(7622),le=s(2120),de=s(194),ce=s(7689),he=s.n(ce);const ue={1:{audio:"presets/birds1_mono.mp3",name:"birds"},2:{audio:"presets/chains1_mono.mp3",name:"chains"},3:{audio:"presets/flute1_mono.mp3",name:"flute"},4:{audio:"presets/horse1_mono.mp3",name:"horse"},5:{audio:"presets/marimba_roll_and_clarinet1_mono.mp3",name:"marimba"},6:{audio:"presets/metalHit1_mono.mp3",name:"metal 1"},7:{audio:"presets/metalHit2_mono.mp3",name:"metal 2"},8:{audio:"presets/sailing1_mono.mp3",name:"sailing"},9:{audio:"presets/snoring1_mono.mp3",name:"snoring"}},ge=6;var pe={name:"App",components:{Sample:H,Reverb:re,Delay:ee},data(){return{samples:[],presets:ue,recording:!1,microphoning:!1,adding:!1}},created(){this.$root.preMaster=new c.wf(-30,3).connect(c.rS),this.initMicrophone(),this.initRecord();const e=new URLSearchParams(window.location.search);this.$root.debug="1"===e.get("debug"),this.$root.debug&&(console.debug("DEBUG mode on"),window.samples=this.samples)},mounted(){this.samples.push({...this.presets[1],idx:0}),this.$root.lastSampleInteractionIdx=0,setTimeout((()=>{window.sample=this.$refs.samples[0]}),1e3),document.addEventListener("keydown",(e=>{e.key>="0"&&e.key<="9"&&this.addPreset(Number(e.key))})),this.setupPaper(),this.resizeCanvas(),window.addEventListener("resize",this.resizeCanvas)},beforeDestroy(){window.removeEventListener("resize",this.resizeCanvas)},methods:{addSample(){this.$refs.fileChooser.click()},addPreset(e){this.adding=!1,this.samples.length>=ge?o()({text:"Maximum number of samples in canvas reached",duration:3e3,gravity:"top",position:"center",stopOnFocus:!0,style:{background:"linear-gradient(to right, #00b09b, #96c93d)"}}).showToast():this.samples.push({...this.presets[e],idx:this.samples.length})},handleSampleFileUpload(e){const t=e.target.files[0];console.debug("Selected file:",t),this.initSample(t)},removeSample(){if(0==this.samples.length)return;const e=this.$refs.samples.find((e=>e.idx==this.$root.lastSampleInteractionIdx));e.$destroy(),this.samples=this.samples.filter((e=>e.idx!=this.$root.lastSampleInteractionIdx)),this.$root.lastSampleInteractionIdx=this.samples.length>0?this.samples[0].idx:null},toggleSimpleRecord(){this.microphoning||(this.recording?(this.stopSimpleRecord(),this.recording=!1):(this.startSimpleRecord(),this.recording=!0))},startSimpleRecord(){this.simpleRecorder=new c.vk,this.$root.preMaster.connect(this.simpleRecorder),this.simpleRecorder.start()},async stopSimpleRecord(){const e=await this.simpleRecorder.stop(),t=URL.createObjectURL(e),s=document.createElement("a");s.download="recording.webm",s.href=t,s.click()},async initRecord(){console.debug("recording..."),this.mediaRecorder=null,this.audioBlobs=[],this.capturedStream=null},async record(){if(this.recording){console.debug("finished recording");const e=await this.stopRecording();if(e){const t=new Audio;t.src=URL.createObjectURL(e),t.play()}this.recording=!1}else console.debug("recording..."),this.startRecording(),this.recording=!0},startRecording(){return navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0}}).then((e=>{this.audioBlobs=[],this.capturedStream=e,this.mediaRecorder=new de.VW(e,{mimeType:"audio/ogg"}),this.mediaRecorder.addEventListener("dataavailable",(e=>{this.audioBlobs.push(e.data)})),this.mediaRecorder.start()})).catch((e=>{console.error(e)}))},stopRecording(){return new Promise((e=>{this.mediaRecorder?(this.mediaRecorder.addEventListener("stop",(()=>{console.debug("stopped");const t=this.mediaRecorder.mimeType,s=new Blob(this.audioBlobs,{type:t});this.capturedStream&&this.capturedStream.getTracks().forEach((e=>e.stop())),e(s)})),this.mediaRecorder.stop()):e(null)}))},convertWavToMp3(e){return new Promise(((t,s)=>{const i=new FileReader;i.onload=function(){const e=this.result,s=oe.EX.readHeader(new DataView(e)),i=new Int16Array(e,s.dataOffset,s.dataLen/2),a=new oe.x3(s.channels,s.sampleRate,128),n=a.encodeBuffer(i),r=a.flush(),o=new Uint8Array(n.length+r.length);o.set(n,0),o.set(r,n.length);const l=new Blob([o],{type:"audio/mp3"});t(l)},i.onerror=function(e){s(e)},i.readAsArrayBuffer(e)}))},downloadFile(e,t){const s=document.createElement("a"),i=URL.createObjectURL(e);s.href=i,s.download=t,document.body.appendChild(s),s.click(),setTimeout((function(){document.body.removeChild(s),window.URL.revokeObjectURL(i)}),0)},async loadSession(e){this.samples=[];const t=new le.nZ(e),s=new le.rd,i=new le.zg(t),a=await i.getEntries(),n=a.find((e=>"config.json"===e.filename)),r=await n.getData(s),o=JSON.parse(r),l=a.filter((e=>e!=n));l.forEach((async e=>{console.debug("entry",e);const t=e.filename.split(".mp3")[0],s=o.samples.find((e=>e.name===t)),i=new le.D7,a=await e.getData(i),n=URL.createObjectURL(a);this.samples.push({audio:n,name:t,position:{x:s.x,y:s.y}}),console.debug(a)})),await i.close()},async saveSession(){if(this.microphoning||this.recording)return;const e=prompt("name to save?");if(!e)return;const t=new le.D7,s=new le.Vx(t),i=this.getSaveData(),a=JSON.stringify(i,null,4),n=new Blob([a],{type:"application/json"}),r=new le.TX(n);await s.add("config.json",r);for(let d=0;d<this.$refs.samples.length;d++){const e=this.$refs.samples[d],t=e.audioNode.buffer;var o=C(t);const i=new Blob([o],{type:"audio/mpeg"}),a=await this.convertWavToMp3(i),n=new le.nZ(a);await s.add(`${e.name}.mp3`,n)}await s.close();const l=await t.getData();this.downloadFile(l,`${e}.digicanvas`)},getSaveData(){return{samples:this.$refs.samples.map((e=>e.getSaveData())),effects:{reverb:this.$refs.reverb.getSaveData(),delay:this.$refs.delay.getSaveData()}}},initMicrophone(){this.microphone=new c.mh,this.recorder=new c.vk,this.microphone.connect(this.recorder),this.microphone.open()},async toggleMicrophone(){if(!this.recording)if(this.microphoning){console.debug("finished microphoning"),this.microphoning=!1;const e=await this.recorder.stop(),t=URL.createObjectURL(e);console.log("blobURL",t),this.samples.push({audio:t,name:"my recording",idx:this.samples.length})}else console.debug("microphoning..."),this.microphoning=!0,this.recorder.start()},handleDrop(e){console.debug("handling drop");const t=e.dataTransfer.files[0];console.debug(t),t&&t.type.startsWith("audio/")?this.initSample(t):t.name.endsWith(".digicanvas")?(console.debug("should load this one"),confirm("Loading this configuration file will loose all current state session. Are you sure you want to proceed?")&&this.loadSession(t)):alert("Please drop a valid audio file.")},initSample(e){const t=new FileReader;t.onload=s=>{const i=new Blob([t.result],{type:e.type});console.debug("BLOB",i);const a=URL.createObjectURL(i),n=new Audio;n.src=a,n.addEventListener("loadedmetadata",(()=>{console.debug("Audio duration:",n.duration),n.duration>5?(console.debug(a),this.samples.push({audio:a,name:e.name.replace(/\.[^/.]+$/,"")})):alert("Samples need to be between 5 and 15 seconds.")})),n.load()},t.readAsArrayBuffer(e)},addSilenceToEnd(e,t){const s=e.duration;if(s>=t)return console.debug("Audio is already equal to or longer than the target duration."),e;const i=e.numberOfChannels,a=e.sampleRate,n=Math.floor(t*a),r=c._O.createBuffer(i,n,a);for(let o=0;o<i;o++){const t=e.getChannelData(o);r.getChannelData(o).set(t)}return r},setupPaper(){const e=this.$refs.paperCanvas;window.onload=()=>{he().setup(e),he().install(e),this.$root.paper=e.paper}},resizeCanvas(){const e=this.$el,t=this.$refs.paperCanvas;t.width=e.clientWidth,t.height=e.clientHeight,he().view&&(he().view.viewSize=new(he().Size)(t.width,t.height))}}},me=pe,fe=(0,j.A)(me,a,n,!1,null,null,null),ve=fe.exports;i.Ay.config.productionTip=!1,new i.Ay({render:e=>e(ve)}).$mount("#app")},6999:function(){},2965:function(){}},t={};function s(i){var a=t[i];if(void 0!==a)return a.exports;var n=t[i]={exports:{}};return e[i].call(n.exports,n,n.exports,s),n.exports}s.m=e,function(){var e=[];s.O=function(t,i,a,n){if(!i){var r=1/0;for(c=0;c<e.length;c++){i=e[c][0],a=e[c][1],n=e[c][2];for(var o=!0,l=0;l<i.length;l++)(!1&n||r>=n)&&Object.keys(s.O).every((function(e){return s.O[e](i[l])}))?i.splice(l--,1):(o=!1,n<r&&(r=n));if(o){e.splice(c--,1);var d=a();void 0!==d&&(t=d)}}return t}n=n||0;for(var c=e.length;c>0&&e[c-1][2]>n;c--)e[c]=e[c-1];e[c]=[i,a,n]}}(),function(){s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,{a:t}),t}}(),function(){s.d=function(e,t){for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})}}(),function(){s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){var e={524:0};s.O.j=function(t){return 0===e[t]};var t=function(t,i){var a,n,r=i[0],o=i[1],l=i[2],d=0;if(r.some((function(t){return 0!==e[t]}))){for(a in o)s.o(o,a)&&(s.m[a]=o[a]);if(l)var c=l(s)}for(t&&t(i);d<r.length;d++)n=r[d],s.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return s.O(c)},i=self["webpackChunkdigicanvas"]=self["webpackChunkdigicanvas"]||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))}();var i=s.O(void 0,[504],(function(){return s(7468)}));i=s.O(i)})();
//# sourceMappingURL=app.bf5e000c.js.map